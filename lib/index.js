"use strict";var _toolkit=require("@reduxjs/toolkit");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=exports.GROUPEND=exports.GROUPBEGIN=exports.CLEAR=exports.REDO=exports.UNDO=void 0;function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}var _=require("lodash"),diff=require("deep-diff").diff,WRAPKEY="__wrapper",DEBUGPREPEND="[easy-redux-undo]=>",LIBRARYPREFIX="@@easy-redux-undo/",UNDOACTION="".concat(LIBRARYPREFIX,"UNDO"),REDOACTION="".concat(LIBRARYPREFIX,"REDO"),CLEARACTION="".concat(LIBRARYPREFIX,"CLEAR"),GROUPBEGINACTION="".concat(LIBRARYPREFIX,"GROUPBEGIN"),GROUPENDACTION="".concat(LIBRARYPREFIX,"GROUPEND"),UNDO=(0,_toolkit.createAction)(UNDOACTION);exports.UNDO=UNDO;var REDO=(0,_toolkit.createAction)(REDOACTION);exports.REDO=REDO;var CLEAR=(0,_toolkit.createAction)(CLEARACTION);exports.CLEAR=CLEAR;var GROUPBEGIN=(0,_toolkit.createAction)(GROUPBEGINACTION);exports.GROUPBEGIN=GROUPBEGIN;var GROUPEND=(0,_toolkit.createAction)(GROUPENDACTION);exports.GROUPEND=GROUPEND;var defaultOptions={maxHistory:100,undoType:UNDOACTION,redoType:REDOACTION,clearType:CLEARACTION,groupBeginType:GROUPBEGINACTION,groupEndType:GROUPENDACTION,include:[],exclude:[]},undoable=function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(b=Object.assign(defaultOptions,b),0<b.include.length&&0<b.exclude.length)return void console.error("".concat(DEBUGPREPEND," cannot have both a 'include' and 'exclude' property, choose one or the other!"));var c=function(a,c,d){var e,f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:void 0,g=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,h=5<arguments.length&&void 0!==arguments[5]?arguments[5]:void 0,l=f?f:a,m=h?h:d,n=!1,o=l.length-1,p=l[o];if(p===b.groupEndType){var q=o-1;for(q;0<=q&&l[q]!==b.groupBeginType;q--);if(0==q&&l[q]!==b.groupBeginType)throw"".concat(DEBUGPREPEND," did not find a closed group of actions to undo, did you forget to send a '").concat(b.groupBeginType,"' action?");p=[];for(var r=o-1;r>=q+1;r--)p.push(l[r]);o=q,n=!0}if(l=l.slice(0,o),e=g?g:_.cloneDeep(c),Array.isArray(e)&&(e["".concat(WRAPKEY)]=e),n)for(var i=0;i<p.length;i++)for(var j=0;j<p[i].length;j++)diff.revertChange(e,!0,p[i][j]);else for(var k=0;k<p.length;k++)diff.revertChange(e,!0,p[k]);return e=Array.isArray(e)?e["".concat(WRAPKEY)]:e,m=n?[b.groupEndType].concat(_toConsumableArray(p),[b.groupBeginType],_toConsumableArray(m)):[p].concat(_toConsumableArray(m)),{past:l,present:e,future:m}},d=function(a,c,d){var e,f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:void 0,g=4<arguments.length&&void 0!==arguments[4]?arguments[4]:void 0,h=5<arguments.length&&void 0!==arguments[5]?arguments[5]:void 0,l=f?f:a,m=h?h:d,n=!1,o=1,p=m[o-1];if(p===b.groupEndType){var q=o;for(q;q<=m.length&&m[q]!==b.groupBeginType;q++);if(q===m.length-1&&m[q]!==b.groupBeginType)throw"".concat(DEBUGPREPEND," did not find a closed group of actions to redo, something must have went wrong!");p=[];for(var r=q-1;r>=o;r--)p.push(m[r]);o=q+1,n=!0}if(m=m.slice(o),e=g?g:_.cloneDeep(c),Array.isArray(e)&&(e["".concat(WRAPKEY)]=e),n)for(var i=0;i<p.length;i++)for(var j=0;j<p[i].length;j++)diff.applyChange(e,!0,p[i][j]);else for(var k=0;k<p.length;k++)diff.applyChange(e,!0,p[k]);return e=Array.isArray(e)?e["".concat(WRAPKEY)]:e,l=n?[].concat(_toConsumableArray(l),[b.groupBeginType],_toConsumableArray(p),[b.groupEndType]):[].concat(_toConsumableArray(l),[p]),{past:l,present:e,future:m}};return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},f=1<arguments.length?arguments[1]:void 0,g=e.past,h=e.present,k=e.future;if("undefined"==typeof h)return{past:[],present:a(void 0,{}),future:[]};var l="number"==typeof f.payload&&0<f.payload?f.payload:1;switch(f.type){case b.groupBeginType:return{past:[].concat(_toConsumableArray(g),[b.groupBeginType]),present:h,future:k};case b.groupEndType:if(g[g.length-1]===b.groupBeginType){console.warn("".concat(DEBUGPREPEND," did not add '").concat(b.groupEndType,"' action; detected that the previous action was '").concat(b.groupBeginType,"' - this would result in an empty group!"));break}else return{past:[].concat(_toConsumableArray(g),[b.groupEndType]),present:h,future:k};case b.clearType:return{past:[],present:h,future:[]};case b.undoType:{if(0===g.length)return{past:g,present:h,future:k};for(var m={},n=1;n<=l&&(m=c(g,h,k,m.past,m.present,m.future),0!==m.past.length);n++);return m}case b.redoType:{if(0===k.length)return{past:g,present:h,future:k};for(var o={},p=1;p<=l&&(o=d(g,h,k,o.past,o.present,o.future),0!==o.past.length);p++);return o}default:{var q,r=a(h,f);if(Array.isArray(r)?q=diff({WRAPKEY:h},{WRAPKEY:r}):"object"===_typeof(r)&&(q=diff(h,r)),"undefined"==typeof q)return e;if(0<b.include.length&&!b.include.includes(f.type)||0<b.exclude.length&&b.exclude.includes(f.type))return{past:g,present:r,future:[]};for(var s=0,t=!1,u=[q],v=g.length-1;0<=v&&g[v]!==b.groupEndType;v--)if(g[v]===b.groupBeginType){t=!0;break}for(var w=g.length-1;0<=w;w--)if(g[w]===b.groupEndType?(++s,t=!0):g[w]===b.groupBeginType?t=!1:!t&&++s,s>=b.maxHistory-1||0===w){if(g[w]===b.groupEndType){var x=w;for(x;0<=x&&g[x]!==b.groupBeginType;x--);u=[].concat(_toConsumableArray(g.slice(x)),[q])}else u=[].concat(_toConsumableArray(g.slice(w)),[q]);break}return{past:u,present:r,future:[]}}}}},_default=undoable;exports["default"]=_default;